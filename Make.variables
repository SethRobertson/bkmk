# -*- makefile -*-
#
# $Id: Make.variables,v 1.86 2002/08/03 23:21:53 dupuy Exp $
#
# ++Copyright LIBBK++
#
# Copyright (c) 2001,2002 The Authors.  All rights reserved.
#
# This source code is licensed to you under the terms of the file
# LICENSE.TXT in this release for further details.
#
# Mail <projectbaka@baka.org> for further information
#
# --Copyright LIBBK--
#
#
# Variables
#

NORMALIZE='			\
	s@//@/@g;		\
	s@/\./@/@g;		\
	s@/[^/.]+/\.\./@/@g;	\
	s@/[^/.]+/\.\./@/@g;	\
	s@/[^/.]+/\.\./@/@g;	\
	s@^/n/[^/]*/@/@;	\
	print;'
NORMALIZEPWD="\$$_ = qq^`$(PWD)`^;"$(NORMALIZE)
CURDIR=$(shell $(PERL) -e $(NORMALIZEPWD))

# this is the directory where libraries will actually be copied; cannot be path
NORMALIZERDIR="\$$_ = qq^`$(PWD)`/$(BK_INSTALLLIBDIR)^;"$(NORMALIZE)
BK_INSTALLRDIR:=$(shell $(PERL) -e $(NORMALIZERDIR))

# this can (and should) be overridden by .user-variables for production builds
BK_INSTALLRPATH=$(BK_INSTALLRDIR)

NORMALIZEPATH="\$$_ = qq^`$(PWD)`/$(BK_INSTALLPROGDIR)^;"$(NORMALIZE)
BK_INSTALLPATH=$(shell $(PERL) -e $(NORMALIZEPATH))

ifndef BK_WANT_LIBTOOL
BK_WANT_LIBTOOL=true
endif

ifeq ($(BK_WANT_LIBTOOL),)
BK_WANT_LIBTOOL=true
endif

#
# Junk
#
BK_NEATSTUFF=$(BK_LOCALJUNK) $(BK_GROUPJUNK) $(BK_PKGJUNK) $(BK_BKJUNK) $(BK_STDJUNK)
BK_CLEANSTUFF=$(BK_NEATSTUFF) $(BK_LOCALCLEANJUNK) $(BK_GROUPCLEANJUNK) $(BK_PKGCLEANJUNK) $(BK_BKCLEANJUNK)
BK_NUKESTUFF=$(BK_CLEANSTUFF) $(BK_NUKEJUNK) $(BK_LOCALNUKEJUNK) $(BK_GROUPNUKEJUNK) $(BK_PKGNUKEJUNK) $(BK_BKNUKEJUNK)
BK_BKJUNK=$(BK_SIMPLE_PROGS) $(BK_LARGE_PROG) $(BK_LARGE_LIB) $(BK_SIMPLE_INTERNALPROGS) $(BK_LARGE_INTERNALPROG) $(BK_LARGE_INTERNALLIB) $(BK_JAVA_JAR)
BK_STDJUNK=*.o *.obj *.lo *.a *.la core tca.log tca.map .libs .inslog* _1001.out a.out mon.out *.core *.class *.err *.htm
BK_BKCLEANJUNK=.depend tags TAGS *.rpt
BK_BKNUKEJUNK=.\\\#* \\\#* *.rej *.orig *~

BK_ALL_FIRST_DIRS=$(BK_INCLUDE_DIRS) $(BK_FIRST_DIRS)
BK_ALL_LAST_DIRS=$(BK_EXECUTABLE_DIRS) $(BK_LAST_DIRS)
BK_ALL_SUBDIR=$(BK_ALL_FIRST_DIRS) $(BK_SUBDIR) $(BK_ALL_LAST_DIRS)

ifeq ($(BK_WANT_STATIC), true)
# Sigh.. libtool *claims* to support both a -static and a --all-static link mode argument,
# but it does not (or at least ours does not).
BK_WANT_LIBTOOL=false
endif

ifeq ($(BK_WANT_LIBTOOL), false)
BK_NO_USER_SHARED_LIBS=true
endif

#
# C source filenames for standard production rules
#
BK_SIMPLE_CSRC:=$(patsubst %,%.c,$(BK_SIMPLE_PROGS) $(BK_SIMPLE_INTERNALPROGS))
BK_LARGE_CSRC:=$(patsubst %.y,%.tab.c,$(BK_LARGE_SRC))
BK_LARGE_CSRC:=$(patsubst %.l,%.c,$(BK_LARGE_CSRC))
BK_LARGE_LIBCSRC:=$(patsubst %.y,%.tab.c,$(BK_LARGE_LIBSRC))
BK_LARGE_LIBCSRC:=$(patsubst %.l,%.c,$(BK_LARGE_LIBCSRC))
_BK_MAN1=$(filter %.1,$(BK_MAN))
_BK_MAN3=$(filter %.3,$(BK_MAN))
_BK_MAN5=$(filter %.5,$(BK_MAN))
_BK_MAN8=$(filter %.8,$(BK_MAN))


#
# Standard commands
#
RRM=$(RM_CONFIG) -rf
RM=$(RM_CONFIG) -f
MKDEP=$(CPP) -M $(CPPFLAGS)
MKDIR=$(MKDIR_CONFIG) -p

# Use -p to preserve timestamps whereever possible. This is mostly so that
# header file installs don't trigger dependencies.

# Install (GNU or BSD)
INSTALL_BINFLAGS=-p -m 775
# install header files read-only to avoid editing them (and not originals)
ifeq ($(findstring CYGWIN,$(BK_OSNAME)),)
INSTALL_INCFLAGS=-p -m 444
else # on CygWin, install -p on read-only files fails
INSTALL_INCFLAGS=-m 444
endif
INSTALL_LIBFLAGS=$(INSTALL_OTHERFLAGS)
INSTALL_OTHERFLAGS=-p -m 664


# Yacc
YFLAGS=
YACCLIBS=-ly

# Lex
LOPTDEBUG= #-CF
LFLAGS=$(LOPTDEBUG)
LEXLIBS=-lfl

# Libtool
LT_CFLAGS=
LT_LDFLAGS=-avoid-version
LT_M_LDFLAGS=-module -avoid-version

ifeq ($(BK_WANT_LIBTOOL), true)
LIBTOOL_COMPILE=$(LIBTOOL) --mode=compile
LIBTOOL_LINK=$(LIBTOOL) --mode=$(LINKMODE)
LIBTOOL_INSTALL=$(LIBTOOL) --mode=install --quiet
else
LIBTOOL_COMPILE=
LIBTOOL_LINK=
LIBTOOL_INSTALL=
BK_INSTALLRPATH=$(BK_INSTALLRDIR)
endif

#
# <WARNING>If $(BK_INSTALLRDIR) != $(BK_INSTALLRPATH), libtool support gets
# quite hairy.  When doing a "production" install, with embedded rpath
# different from the install directory, libtool install gets fussy and
# fails (on library installs) if it can't locate library dependencies in the
# embedded runpath (where they may not yet, or ever, be installed).  When
# installing programs, when libtool is unable to find the libraries in the
# embedded runpath, it installs the script wrappers instead of relinking.
#
# To prevent these problems, after running libtool -mode link on programs, we
# edit the wrapper scripts to prevent libtool from (a) complaining that libtool
# libraries that are dependencies of the program are not installed in the
# embedded runpath directory, or (b) appending the install directory into the
# native executable runpath (this latter is a side-effect of the editing we
# perform on installed libtool archives, described below).
#
# After running libtool -mode install on libraries or modules, we modify any
# dependencies on libtool libraries in the embedded runpath directory so that
# libtool looks in the install directory instead; for libraries (but not
# modules) we also set the libtool idea of the embedded runpath to the install
# directory.  (The system native shared libraries still have the embedded
# runpath - only the libtool library scripts are modified.)
#
# For these tricks to work, relinking must always be performed at install time
# (by default, this only happens for program files, or when there are
# dependencies on uninstalled libtool libraries, we force libtool to always
# relink when installing, by using a special mode called 'prelink'; it works
# just like --mode=link except that it forces relinking when --mode=install).
# Furthermore, when relinking libraries/modules, we need to override the
# use of libtool library dependencies' (edited) idea of their locations with
# the command line -rpath; both this and the prelink hack are implemented as
# local mods to ltmain.sh.
#
# This really is quite a mess, but is simpler (and more robust in the face of
# libtool upgrades) than extensive reworking of libtool to handle the case
# where you want to install things with a standard RPATH, but can't put any
# files there.</WARNING>
#

ifeq ($(BK_INSTALLRDIR),$(BK_INSTALLRPATH))
LINKMODE=link
EDIT_LT_PROGLINK=:
EDIT_LT_LIBINSTALL=:
EDIT_LT_MODINSTALL=:
else
LINKMODE=prelink
EDIT_LT_PROGLINK=\
	$(PERL) -pi.BAK -e " \
	  s|\S*(/[^/\s]*\.la)|$(BK_INSTALLRDIR)\1|g \
	    if (/notinst_deplibs=/); \
	  s|([,])(/n/[^/]+)?$(BK_INSTALLRDIR)|\1$(BK_INSTALLRPATH)|g \
	    if (/^relink_command=/);" $@
EDIT_LT_LIBINSTALL=\
	$(PERL) -pi -e " \
	  s|$(BK_INSTALLRPATH)(/[^ ]*\.la)|$(BK_INSTALLRDIR)\1|g \
	    if (/^dependency_libs=/); \
	  s|libdir='$(BK_INSTALLRPATH)'|libdir='$(BK_INSTALLRDIR)'| \
	    if (/^libdir=/);" $(BK_INSTALLRDIR)/$(^F)
EDIT_LT_MODINSTALL=\
	$(PERL) -pi -e " \
	  s|$(BK_INSTALLRPATH)(/[^ ]*\.la)|$(BK_INSTALLRDIR)\1|g \
	    if (/^dependency_libs=/);" $(BK_INSTALLRDIR)/$(^F)
endif

######################################################################
# Java stuff
JAVACFLAGS=$(USER_JAVAC_FLAGS) -g
JARFLAGS=-cfm

BK_JAVA_CPATH=$(subst :,$(PATH_SEPARATOR),$(BK_JAVADIR):$(BK_JAVA_CP))
BK_JAVA_TESTCP=$(BK_JAVA_CPATH)$(PATH_SEPARATOR)/usr/local/java/lib/junit.jar

BK_JAVA_PKGDOT=$(subst /,.,$(BK_JAVA_PKG))

# file list variables for Java production rules

BK_JAVA_CLASS:=$(patsubst %.java,$(BK_JAVA_PKG)/%.class,$(BK_JAVA_SRC))
BK_JAVA_TCLASS:=$(patsubst %.java,$(BK_JAVA_PKG)/%.class,$(BK_JAVA_TEST))

# These are recursively expanded variables using =, rather than directly
# expanded variables using :=, so that the $(wildcard ...) matching will
# occur after the java compiler has had a chance to create the inner class
# class files.  Unfortunately, somehow $(wildcard) doesn't see the new files.
#BK_JAVA_ICLASS_TMP=\
#	$(foreach tmp, $(patsubst %.class,%,$(BK_JAVA_CLASS)), \
#		$(wildcard $(BK_JAVADIR)/$(tmp)$$*.class))
BK_JAVA_ICLASS_TMP=$(filter-out %$$*.class, \
  $(shell echo $(patsubst %.class,$(BK_JAVADIR)/%\$$*.class,$(BK_JAVA_CLASS))))
BK_JAVA_ICLASS=\
	$(subst $$,\$$,$(patsubst $(BK_JAVADIR)/%,%,$(BK_JAVA_ICLASS_TMP)))

BK_JAVA_PROPS:=$(wildcard $(GROUPTOP)/$(LOCALE)/*.properties)
BK_JAVA_LOCALE:=$(patsubst $(GROUPTOP)/$(LOCALE)/%,%,$(BK_JAVA_PROPS))

BK_JAVA_PNGS:=$(foreach I,$(IMAGES),$(wildcard $(GROUPTOP)/$(I)/*.png))
BK_JAVA_JPGS:=$(foreach I,$(IMAGES),$(wildcard $(GROUPTOP)/$(I)/*.jpg))
BK_JAVA_GIFS:=$(foreach I,$(IMAGES),$(wildcard $(GROUPTOP)/$(I)/*.gif))
BK_JAVA_IMAGES:=$(patsubst $(GROUPTOP)/%,%,$(BK_JAVA_PNGS) $(BK_JAVA_JPGS) $(BK_JAVA_GIFS))

BK_JAVA_PKG_CLASS:=$(patsubst %,$(BK_JAVADIR)/%,$(BK_JAVA_CLASS))
BK_JAVA_PKG_TCLASS:=$(patsubst %,$(BK_JAVADIR)/%,$(BK_JAVA_TCLASS))
BK_JAVA_PKG_SRC:=$(patsubst %,$(BK_JAVADIR)/$(BK_JAVA_PKG)/%,$(BK_JAVA_SRC))
BK_JAVA_PKG_TEST:=$(patsubst %,$(BK_JAVADIR)/$(BK_JAVA_PKG)/%,$(BK_JAVA_TEST))
# AUX is deprecated - use images instead
BK_JAVA_PKG_AUX:=$(patsubst %,$(BK_JAVADIR)/$(BK_JAVA_PKG)/%,$(BK_JAVA_AUX))
BK_JAVA_PKG_LOCALE:=$(patsubst %,$(BK_JAVADIR)/%,$(BK_JAVA_LOCALE))
BK_JAVA_PKG_IMAGES:=$(patsubst %,$(BK_JAVADIR)/%,$(BK_JAVA_IMAGES))

BK_JAVA_MF:=$(patsubst %.jar,%.MF,$(BK_JAVA_JAR))
BK_JAVA_HELP_JAR:=$(patsubst %, $(BK_JAVA_HELP)_%.jar, $(BK_JAVA_HELP_LANG))

######################################################################
# Jtest stuff
JTEST=/usr/local/parasoft/bin/jtest

JTESTERR={ $(SED) -n -e 's/^\[\([^,]*\), line \([0-9]*\)\]/\1:\2:/' \
		     -e '/^ERRORS/,/^Class Metrics:/p' $*.err && false; }

ifeq ($(DISPLAY),)
JTESTOUT=-nogui
endif
ifeq ($(JTESTUI),)
JTESTOUT=-nogui
endif

ifeq ($(JTESTOUT),)
JTESTERR=true
# don't be nuking generated .ctp files when user may have tweaked them
.PRECIOUS: %.ctp
endif

BK_JAVA_JTEST:=$(patsubst %.java,%.rpt,$(BK_JAVA_SRC))
# what about inner classes?
#BK_JAVA_JTEST+=$(patsubst $(BK_JAVA_PKG)/%.class,%.rpt,$(BK_JAVA_ICLASS))


######################################################################
# C stuff

# Traditional resolver
#RESOLVER_DEFINES=-DRESOLVER=RESOLV
RESOLVER_DEFINES=
RESOLVER_INCLUDES=
RESOLVER_LDS=
#make it work on Windows for now
#LIBRESOLVER=-lresolv $(LIB44BSD)
LIBRESOLVER=
LIB44BSD=#-l44bsd

# Libraries
DBM_LIBS=-ldb
TERMINAL_LIBS=-ltermcap
MATH_LIBS=-lm
COMPRESS_LIBS=-lz

# BK issues
ifneq ($(NO_STDBKCCSTUFF),true)
BK_DEFINES+= $(RESOLVER_DEFINES)
BK_INCS= $(RESOLVER_INCLUDES)
BK_LDS= $(RESOLVER_LDS)
BK_LIBS= -lbk -ldict -lfsma -lpq -lpopt $(ACLIBS) $(LIBRESOLVER) $(MATH_LIBS) $(COMPRESS_LIBS)
endif # NO_STDBKCCSTUFF

ifeq ($(BK_USING_BOUNDS_CHECKING),true)
ifeq ($(CC_CONFIG),gcc)
CC_CONFIG=$(BGCC)
CCOPTS+=-fbounds-checking
COMPILER_NAME=gcc
BK_DEFINES+=-DBGCC_BOUNDS_CHECKING
endif
# NB: At SYSD, this does not yet work
ifeq ($(CXX_CONFIG),g++)
CXXOPTS+=-fbounds-checking
COMPILER_NAME=gcc
endif
endif

ifeq ($(CC_CONFIG),gcc)
COMPILER_NAME=gcc
endif

# C
CC_normal=$(CC_CONFIG) $(CCOPTS)
CC_strict=$(CXX_CONFIG) $(CXXOPTS)
#CC=$(CC_strict)
CC=$(CC_normal)
CXX=$(CXX_CONFIG) $(CXXOPTS)

# gcc options common to both gcc and bgcc
ifeq ($(COMPILER_NAME),gcc)
COMPILER_DEBUG+=-Wmissing-prototypes -Wstrict-prototypes -Wchar-subscripts -Wcomment -Wformat -Wimplicit -Wmain -Wmultichar -Wswitch -Wshadow -Wtrigraphs -Wunused $(COMPILER_DEBUG_ERROR)

# options for gcc only 
ifeq ($(CC_CONFIG),gcc)
COMPILER_DEBUG+=-W -Wno-unused-parameter -Wreturn-type -Wpointer-arith 
endif

ifneq ($(NO_WERROR),true)
COMPILER_DEBUG_ERROR=-Werror
endif

ifneq ($(NO_OPT),true)
ifneq ($(BK_USING_INSURE),true)
ifeq ($(BK_DEBUG_OPT),true)
COPTDEBUG+=-O2
else
COPTDEBUG+=-O3 -mcpu=i686 -march=i686 -fforce-addr -funroll-loops -frerun-cse-after-loop -frerun-loop-opt -malign-functions=4
endif
# gcc doesn't support -Wuninitialized without -O. And if using insure++ you
# get it anyway.
COMPILER_DEBUG+=-Wuninitialized 
endif
endif

ifneq ($(NO_DEBUG),true)
COPTDEBUG+=-g $(COMPILER_DEBUG)
else
COPTDEBUG+=-fomit-frame-pointer
endif

ifeq ($(BK_WANT_STATIC),true)
LDFLAGS+=$(LINK_STATIC_FLAG)
endif

endif # CC is gcc

CFLAGS=$(COPTDEBUG)
CPPFLAGS=$(BK_ALLINCS) $(BK_ALLDEFINES)
LDFLAGS+=$(BK_ALLLDS)
LDLIBS=$(BK_ALLLIBS)

OBJEXT=.$(OBJEXT_CONFIG)
ifeq ($(strip $(EXEEXT_CONFIG)),)
EXEEXT=
else
EXEEXT=.$(EXEEXT_CONFIG)
endif

######################################################################
# What are you using, and what do you want?

ifeq ($(BK_WANT_LIBTOOL),false)
LT=
LTCC=
LTLD=
LIBTOOL=: no-libtool [BK_WANT_LIBTOOL=false]
LIBEXT=.a
LT_CFLAGS=
LT_LDFLAGS=
else
LT=$(LIBTOOL)
LTCC=$(LIBTOOL_COMPILE)
LTLD=$(LIBTOOL_LINK)
LIBEXT=.la
OBJEXT=.lo
top_builddir=$(BKMKDIR)
endif

ifeq ($(BK_USING_GPROF),true)
CFLAGS += -pg
endif

ifeq ($(BK_USING_PROF),true)
CFLAGS += -p
endif

ifeq ($(BK_USING_DMALLOC),true)
BK_LIBS+= -ldmalloc
BK_DEFINES+=-DUSING_DMALLOC -DDMALLOC_FUNC_CHECK
endif

ifeq ($(BK_USING_INSURE),true)
BK_DEFINES+=-D__INSIGHT__
CC=$(INSURE)
endif

OS_SEARCHPATH=/usr/local/lib /usr/lib /usr/local/gnu/lib

BK_ALLDEFINES=$(LOCAL_DEFINES) $(GROUP_DEFINES) $(PKG_DEFINES) $(BK_DEFINES) $(OS_DEFINES)
BK_ALLINCS=$(LOCAL_INCS) $(GROUP_INCS) $(PKG_INCS) $(BK_INCS) $(OS_INCS)
BK_ALLLDS=$(LOCAL_LDS) $(GROUP_LDS) $(PKG_LDS) $(BK_LDS) $(OS_LDS)
BK_ALLLIBS=$(LOCAL_LIBS) $(GROUP_LIBS) $(PKG_LIBS) $(BK_LIBS) $(OS_LIBS)
BK_LIBDIR=$(OS_SEARCHPATH) $(patsubst -L%,%,$(filter -L%,$(BK_ALLLDS)))


######################################################################
# Tags
CTAGS=ctags
ETAGS=etags


######################################################################
# These are built in to the shell, so you don't need to use them, but
# they are defined for the use of the excessively paranoid
CD=cd
ECHO=echo

######################################################################
# BUILD directory independence
vpath %.h $(BK_TRUECWD)
vpath %.c $(BK_TRUECWD)
vpath %.l $(BK_TRUECWD)
vpath %.y $(BK_TRUECWD)
vpath %.3 $(BK_TRUECWD)
vpath %.5 $(BK_TRUECWD)
vpath %.1 $(BK_TRUECWD)
vpath %.8 $(BK_TRUECWD)

# -l library search path
vpath %.a $(GROUPTOP)/lib $(GROUPTOP)/lib/.libs
vpath %.a $(BK_INSTALLLIBDIR) $(BK_LIBDIR)
vpath %$(LIBEXT) $(GROUPTOP)/lib $(BK_INSTALLLIBDIR) $(BK_LIBDIR)
